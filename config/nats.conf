# Ultra-performance NATS configuration
server_name: "ultra-siem-nats"

# Network configuration
host: "0.0.0.0"
port: 4222

# Monitoring
http_port: 8222
https_port: 8443

# JetStream configuration for persistent streaming
jetstream {
    store_dir: "/data"
    max_memory_store: 8GB
    max_file_store: 100GB
    
    # Domain for clustering
    domain: "siem-cluster"
    
    # Limits
    max_streams: 1000
    max_consumers: 5000
}

# Cluster configuration for scalability
cluster {
    name: "siem-cluster"
    listen: "0.0.0.0:6222"
    
    # Authorization
    authorization {
        user: "cluster_admin"
        password: $NATS_CLUSTER_PASSWORD
        timeout: 2
        permissions: {
            publish: {
                allow: ["threats.>", "events.>", "metrics.>"]
            }
            subscribe: {
                allow: ["threats.>", "events.>", "metrics.>", "_INBOX.>"]
            }
        }
    }
    
    # Routes to other servers (for clustering)
    routes: [
        "nats://nats-node-1:6222"
        "nats://nats-node-2:6222"
    ]
}

# Authentication and authorization
authorization {
    users: [
        {
            user: "admin"
            password: $NATS_PASSWORD
            permissions: {
                publish: {
                    allow: ["threats.>", "events.>", "metrics.>", "admin.>"]
                }
                subscribe: {
                    allow: ["threats.>", "events.>", "metrics.>", "admin.>", "_INBOX.>"]
                }
            }
        }
        {
            user: "processor"
            password: $NATS_PROCESSOR_PASSWORD
            permissions: {
                publish: {
                    allow: ["metrics.processor.>"]
                }
                subscribe: {
                    allow: ["threats.detected", "events.>"]
                }
            }
        }
        {
            user: "collector"
            password: $NATS_COLLECTOR_PASSWORD
            permissions: {
                publish: {
                    allow: ["threats.>", "events.>"]
                }
                subscribe: {
                    allow: ["_INBOX.>"]
                }
            }
        }
    ]
}

# TLS configuration
tls {
    cert_file: "/config/certs/server.crt"
    key_file: "/config/certs/server.key"
    ca_file: "/config/certs/ca.crt"
    verify: true
    timeout: 5
}

# Logging
log_file: "/var/log/nats.log"
logtime: true
debug: false
trace: false
syslog: true

# Performance tuning
max_connections: 65536
max_subscriptions: 1000000
max_pending: 134217728  # 128MB
max_payload: 8388608    # 8MB

# Write deadline for slow consumers
write_deadline: "10s"

# Ping interval
ping_interval: "2m"
ping_max: 3

# Memory and CPU limits
max_control_line: 4096
max_memory: 16GB

# Client connection limits
connect_timeout: "5s"

# Message limits per client
max_msgs: 1000000

# Profiling (disable in production)
prof_port: 0

# System account for internal messaging
system_account: "SYS"

# Operator mode (for advanced deployments)
# operator: "/config/operators/main.jwt" 